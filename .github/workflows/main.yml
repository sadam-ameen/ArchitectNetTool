name: Build Android APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Android SDK and NDK
      uses: android-actions/setup-android@v3
      with:
        ndk: "25.2.9519653"
        sdk: "34"
        cmake: "3.22.1"
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Buildozer dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          git \
          wget \
          curl \
          zip \
          unzip \
          openjdk-11-jdk \
          zlib1g-dev \
          libncurses5-dev \
          libffi-dev \
          libssl-dev \
          autoconf \
          libtool \
          pkg-config \
          cmake \
          ninja-build \
          build-essential
        
        sudo update-alternatives --set java /usr/lib/jvm/java-11-openjdk-amd64/bin/java
        echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV
    
    - name: Install Buildozer and Cython
      run: |
        pip3 install --upgrade pip setuptools wheel
        pip3 install cython==0.29.33
        pip3 install buildozer==1.5.0
        pip3 install kivy==2.3.0 requests
        
    - name: Configure Buildozer with correct NDK
      run: |
        # تنظيف أي إعدادات سابقة
        rm -rf ~/.buildozer 2>/dev/null || true
        
        # إنشاء buildozer.spec إذا لم يكن موجوداً
        if [ ! -f "buildozer.spec" ]; then
          buildozer init
        fi
        
        # تحديث buildozer.spec مع الإعدادات الصحيحة
        cat > buildozer.spec << 'EOF'
[app]
title = Architect Net
package.name = stealthinjector
package.domain = org.test
source.dir = .
source.include_exts = py,png,jpg,kv,atlas,ttf
version = 1.0

requirements = python3,kivy==2.3.0,requests,urllib3

orientation = portrait
fullscreen = 0
log_level = 2

# ⭐⭐ إعدادات أندرويد المهمة ⭐⭐
android.api = 34
android.minapi = 21
android.sdk = 34
android.ndk = 25.2.9519653
android.ndk_path = /usr/local/lib/android/sdk/ndk/25.2.9519653

android.permissions = INTERNET, ACCESS_NETWORK_STATE

android.arch = arm64-v8a
android.accept_sdk_license = True

p4a.branch = master
android.skip_update = False

[buildozer]
log_level = 2
warn_on_root = 1
EOF
        
        # تعيين متغيرات البيئة المطلوبة
        echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=/usr/local/lib/android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
    
    - name: Build APK with Buildozer (مع استخدام NDK الصحيح)
      timeout-minutes: 60
      run: |
        # تنظيف كامل
        rm -rf .buildozer bin *.apk build.log 2>/dev/null || true
        
        echo "=== Starting Buildozer with NDK 25 ==="
        
        # تعيين متغيرات البيئة لـ Buildozer
        export ANDROID_HOME=/usr/local/lib/android/sdk
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/25.2.9519653
        export ANDROID_NDK=/usr/local/lib/android/sdk/ndk/25.2.9519653
        export ANDROID_NDK_ROOT=/usr/local/lib/android/sdk/ndk/25.2.9519653
        
        # إضافة المسارات إلى PATH
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_NDK_HOME
        
        # منع Buildozer من تنزيل NDK الخاص به
        export USE_BUILDOZER_NDK=0
        
        # تشغيل Buildozer مع سجل مفصل
        buildozer android clean 2>&1 | tee -a build.log
        
        echo "=== Running buildozer debug ==="
        buildozer -v android debug 2>&1 | tee -a build.log
        
        # التحقق من وجود APK
        if find bin -name "*.apk" 2>/dev/null | grep -q .; then
          echo "✅✅✅ BUILD SUCCESSFUL! APK found:"
          ls -la bin/*.apk
          exit 0
        else
          echo "❌❌❌ BUILD FAILED!"
          echo "=== Checking logs ==="
          tail -100 build.log
          
          # تحقق من ملفات السجل الإضافية
          if [ -d ".buildozer" ]; then
            echo "=== Buildozer logs ==="
            find .buildozer -name "*.log" -exec tail -50 {} \;
          fi
          
          exit 1
        end
    
    - name: Upload APK on success
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Architect-Stealth-APK
        path: bin/*.apk
        
    - name: Upload all logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Failure-Logs
        path: |
          build.log
          .buildozer/
